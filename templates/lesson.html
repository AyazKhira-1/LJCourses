<!DOCTYPE html>
<html lang="en" data-bs-theme="light">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>{{ lesson.title if lesson else 'Lesson' }} - LJCourses</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

    <!-- Common CSS -->
    <link href="{{ url_for('static', filename='css/common.css' ) }}" rel="stylesheet" />
    <!-- Lesson CSS -->
    <link href="{{ url_for('static', filename='css/lesson.css' ) }}" rel="stylesheet" />
</head>

<body class="d-flex flex-column vh-100 overflow-hidden lesson-page" data-lesson-id="{{ lesson.id if lesson else '' }}">
    <!-- Header -->
    <header class="border-bottom bg-white sticky-top">
        <div class="container-fluid px-4">
            <div class="row align-items-center py-3">
                <!-- Brand -->
                <div class="col-auto">
                    <a href="{{ url_for('my_courses') }}"
                        class="d-flex align-items-center gap-2 fw-bold fs-5 brand-text text-decoration-none">
                        <span class="material-icons fs-3 text-primary">school</span>
                        <span>LJCourses</span>
                    </a>
                </div>

                <!-- Breadcrumb -->
                <div class="col d-none d-md-block">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0 small">
                            <li class="breadcrumb-item"><a href="{{ url_for('my_courses') }}">My Courses</a></li>
                            {% if course %}
                            <li class="breadcrumb-item"><a
                                    href="{{ url_for('course_overview', course_slug=course.slug) }}"
                                    class="text-truncate" style="max-width: 150px;">{{ course.title }}</a></li>
                            {% endif %}
                            {% if lesson %}
                            <li class="breadcrumb-item active text-truncate" style="max-width: 200px;"
                                aria-current="page">{{ lesson.title }}</li>
                            {% endif %}
                        </ol>
                    </nav>
                </div>

                <!-- User Profile -->
                <div class="col-auto">
                    <div class="d-flex align-items-center gap-3">
                        <button class="btn btn-link text-secondary p-2" onclick="toggleDarkMode()"
                            aria-label="Toggle Theme">
                            <span class="material-icons icon-dark-mode">wb_sunny</span>
                            <span class="material-icons icon-light-mode">nightlight</span>
                        </button>
                        <div class="vr" style="height: 2.5rem;"></div>
                        <a href="{{ url_for('profile') }}" class="d-flex align-items-center gap-3 text-decoration-none">
                            <div class="text-end d-none d-sm-block">
                                <p id="header-user-name" class="mb-0 fw-semibold small text-secondary">{{ user.full_name
                                    if user else 'Loading...' }}</p>
                                <p id="header-user-role" class="mb-0 text-secondary" style="font-size: 0.75rem;">
                                    {{ user.role|title if user else 'Loading...' }}</p>
                            </div>
                            <img id="header-user-photo"
                                src="{{ user.profile_image if user and user.profile_image else 'https://via.placeholder.com/40' }}"
                                class="rounded-circle border border-2 border-white shadow-sm profile-image"
                                style="width: 2.5rem; height: 2.5rem;" alt="Profile">
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="d-flex flex-fill overflow-hidden">
        <!-- Main Content Area -->
        <main class="flex-fill overflow-auto bg-light">
            <div class="container-fluid p-4 p-md-5" style="max-width: 80rem;">
                {% if lesson %}
                <!-- Video Player -->
                <div class="ratio ratio-16x9 rounded-3 overflow-hidden shadow-lg mb-4">
                    <video id="lesson-video" controls class="w-100 h-100" style="background-color: #000;">
                        <source
                            src="{{ lesson.video_url or 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4' }}"
                            type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>

                <!-- Lesson Header -->
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
                    <div>
                        <h1 class="h3 fw-bold mb-1">{{ '%02d'|format(lesson.order) }}. {{ lesson.title }}</h1>
                        <p class="text-secondary small mb-0">
                            {% if lesson.video_duration %}
                            <span class="material-icons align-middle" style="font-size: 1rem;">schedule</span>
                            {{ (lesson.video_duration // 60)|int }}m {{ lesson.video_duration % 60 }}s
                            {% endif %}
                        </p>
                    </div>
                    <div class="d-flex gap-2 flex-shrink-0">
                        <button class="btn btn-outline-secondary d-flex align-items-center gap-2 px-3 py-2"
                            id="markCompleteBtn">
                            <span class="material-icons" style="font-size: 1.25rem;">check_circle_outline</span>
                            <span>Mark Complete</span>
                        </button>
                        {% set current_index = lessons.index(lesson) if lesson in lessons else 0 %}
                        {% if current_index < lessons|length - 1 %} <a
                            href="{{ url_for('lesson', lesson_id=lessons[current_index + 1].id) }}"
                            class="btn btn-primary d-flex align-items-center gap-2 px-3 py-2">
                            <span>Next Lesson</span>
                            <span class="material-icons" style="font-size: 1.25rem;">arrow_forward</span>
                            </a>
                            {% endif %}
                    </div>
                </div>

                <!-- Content Card -->
                <div class="card border-0 shadow-sm">
                    <!-- Tabs -->
                    <ul class="nav nav-tabs border-bottom px-3" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab"
                                data-bs-target="#overview">Overview</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#resources">Resources</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#qa">Q&A</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#notes">Notes</button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content p-4">
                        <div class="tab-pane fade show active" id="overview">
                            <h5 class="fw-bold mb-3">About this lesson</h5>
                            <p class="text-secondary mb-3">
                                {{ lesson.description or 'No description available for this lesson.' }}
                            </p>
                            {% if course %}
                            <p class="text-secondary mb-4">
                                This lesson is part of the <strong>{{ course.title }}</strong> course.
                            </p>
                            {% endif %}
                        </div>
                        <div class="tab-pane fade" id="resources">
                            <p class="text-secondary">Resource files and links will appear here.</p>
                        </div>
                        <div class="tab-pane fade" id="qa">
                            <p class="text-secondary">Questions and answers will appear here.</p>
                        </div>
                        <div class="tab-pane fade" id="notes">
                            <p class="text-secondary">Your lesson notes will appear here.</p>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- No Lesson Found -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <span class="material-icons text-secondary mb-3" style="font-size: 4rem;">play_disabled</span>
                        <h4 class="fw-bold mb-2">No Lesson Available</h4>
                        <p class="text-secondary mb-3">The lesson you're looking for doesn't exist.</p>
                        <a href="{{ url_for('my_courses') }}" class="btn btn-primary">Go to My Courses</a>
                    </div>
                </div>
                {% endif %}
            </div>
        </main>

        <!-- Course Sidebar -->
        {% if course and lessons %}
        <aside class="sidebar-right d-none d-lg-flex flex-column border-start bg-white" style="width: 24rem;">
            <div class="p-4 border-bottom bg-light">
                <h6 class="fw-bold mb-2">Course Content</h6>
                <div class="d-flex justify-content-between align-items-center small text-secondary mb-2">
                    <span>{{ progress_percent|default(0) }}% Completed</span>
                    <span>{{ completed_count|default(0) }}/{{ lessons|length }} Lessons</span>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar" role="progressbar" aria-valuenow="{{ progress_percent|default(0) }}"
                        aria-valuemin="0" aria-valuemax="100" style="width: {{ progress_percent|default(0) }}%;"></div>
                </div>
            </div>

            <div class="flex-fill overflow-auto">
                <ul class="list-group list-group-flush">
                    {% for l in lessons %}
                    {% set is_current = l.id == lesson.id %}
                    {% set progress = progress_map.get(l.id|string) %}
                    {% set is_completed = progress.is_completed if progress else false %}

                    <li
                        class="list-group-item lesson-item {% if is_completed %}completed{% endif %} {% if is_current %}active border-start border-primary border-3{% endif %}">
                        <a href="{{ url_for('lesson', lesson_id=l.id) }}" class="text-decoration-none">
                            <div class="d-flex gap-2 {% if not is_completed and not is_current %}opacity-75{% endif %}">
                                {% if is_completed %}
                                <span class="material-icons text-success">check_circle</span>
                                {% elif is_current %}
                                <span class="material-icons text-primary">play_circle_filled</span>
                                {% else %}
                                <span class="material-icons text-secondary">play_circle_filled</span>
                                {% endif %}
                                <div class="flex-fill">
                                    <p
                                        class="mb-1 small {% if is_completed %}text-decoration-line-through text-secondary{% elif is_current %}fw-bold text-primary{% endif %}">
                                        {{ '%02d'|format(l.order) }}. {{ l.title }}
                                    </p>
                                    <div class="d-flex gap-2 align-items-center">
                                        {% if is_completed %}
                                        <span class="badge bg-success bg-opacity-10 text-success">Completed</span>
                                        {% elif is_current %}
                                        <span class="badge bg-opacity-10 text-primary">Playing</span>
                                        {% endif %}
                                        <span class="text-secondary" style="font-size: 0.7rem;">
                                            {{ (l.video_duration // 60)|int if l.video_duration else 0 }}:{{
                                            '%02d'|format(l.video_duration % 60 if l.video_duration else 0) }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </aside>
        {% endif %}
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>

    <!-- Common JS -->
    <script src="{{ url_for('static', filename='js/common.js' ) }}"></script>
    <script src="{{ url_for('static', filename='js/header.js' ) }}"></script>
    <script src="{{ url_for('static', filename='js/lesson.js' ) }}"></script>
</body>

</html>